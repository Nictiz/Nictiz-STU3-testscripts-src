<?xml version="1.0" encoding="UTF-8"?>
<TestScript xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript">
   <id value="Sending-XIS-scenario1.3b-xml"/>
   <meta>
      <profile value="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript"/>
   </meta>
   <url value="http://nictiz.nl/fhir/TestScript/Sending-XIS-scenario1.3b-xml"/>
   <version value="stu3-4.0- patchlevel 2022-03"/>
   <name value="eOverdracht receiving system - scenario 1.3b  - XML Format"/>
   <status value="active"/>
   <publisher value="Nictiz"/>
   <contact>
      <name value="Nictiz"/>
      <telecom>
         <system value="email"/>
         <value value="kwalificatie@nictiz.nl"/>
         <use value="work"/>
      </telecom>
   </contact>
   <description value="Test for eOverdracht sending systems according to qualification scenario 1.3b"/>
   <origin>
      <index value="1"/>
      <profile>
         <system value="http://hl7.org/fhir/testscript-profile-origin-types"/>
         <code value="FHIR-Client"/>
      </profile>
   </origin>
   <destination>
      <index value="1"/>
      <profile>
         <system value="http://hl7.org/fhir/testscript-profile-destination-types"/>
         <code value="FHIR-Server"/>
      </profile>
   </destination>
   <fixture id="initial-task-fixture">
      <resource>
         <reference value="../_reference/resources/resources-specific/eOverdracht-Task-eov-test-1_3b-01-ACCEPTED.xml"/>
      </resource>
   </fixture>
   <fixture id="completed-task-fixture">
      <resource>
         <reference value="../_reference/resources/resources-specific/eOverdracht-Task-eov-test-1_3b-01-COMPLETED.xml"/>
      </resource>
   </fixture>
   <profile id="eOverdracht-NursingHandoff">
      <reference value="http://nictiz.nl/fhir/StructureDefinition/eOverdracht-NursingHandoff-Adults"/>
   </profile>
   <profile id="eOverdracht-Task">
      <reference value="http://nictiz.nl/fhir/StructureDefinition/eOverdracht-Task"/>
   </profile>
   <variable>
      <name value="patient-token-id"/>
      <defaultValue value="Bearer 7da0de73-a3ad-41af-9272-1a5e8f1113f2"/>
      <description value="OAuth Token for current patient"/>
   </variable>
   <variable>
      <name value="task-id"/>
      <expression value="Task.id"/>
      <sourceId value="initial-task-fixture"/>
   </variable>
   <variable>
      <name value="task-accepted"/>
      <expression value="Bundle.entry.where(resource is Task).resource.where(status = 'accepted')"/>
      <sourceId value="search-accepted-tasks-response"/>
   </variable>
   <variable>
      <name value="nursing-handoff-id"/>
      <expression value="Bundle.entry.where(resource is Task).resource.where(status = 'accepted').input.where(type.coding.system = 'http://snomed.info/sct' and type.coding.code = '371535009').value.reference.replace('Composition/', '')"/>
      <sourceId value="get-accepted-task-response"/>
   </variable>
   <setup in-targets="internal">
      <action>
         <operation>
            <type>
               <system value="http://hl7.org/fhir/testscript-operation-codes"/>
               <code value="updateCreate"/>
            </type>
            <resource value="Task"/>
            <label value="CreateQuestionnaireProvisioningTask"/>
            <description value="Reset the Nictiz eOverdracht test Task resources to initial status, using the update (PUT) operation of the target FHIR server for use in eOverdracht qualification testing. The target XIS FHIR server is expected to support resource create via the update (PUT) operation for client assigned ids."/>
            <accept value="xml"/>
            <contentType value="xml"/>
            <params value="/${task-id}"/>
            <requestHeader>
               <field value="Authorization"/>
               <value value="${patient-token-id}"/>
            </requestHeader>
            <responseId value="setup-task-response"/>
            <sourceId value="initial-task-fixture"/>
         </operation>
      </action>
      <action>
         <assert>
            <description value="Confirm that the operation was succesful"/>
            <operator value="in"/>
            <responseCode value="200,201"/>
         </assert>
      </action>
   </setup>
   <test id="Scenario-1.3b-ServeTask">
      <name value="Scenario-1.3b - Serve eOverdracht Task for patient XXX_Ven"/>
      <description value="Test sending XIS to serve the eOverdracht Task."/>
      <action>
         <operation>
            <type>
               <system value="http://hl7.org/fhir/testscript-operation-codes"/>
               <code value="read"/>
            </type>
            <resource value="Task"/>
            <description value="Test server to serve Task resource."/>
            <accept value="xml"/>
            <destination value="1"/>
            <origin value="1"/>
            <params value="${task-id}"/>
            <requestHeader>
               <field value="Authorization"/>
               <value value="${patient-token-id}"/>
            </requestHeader>
         </operation>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Confirm that the operation was succesful"/>
            <operator value="in"/>
            <responseCode value="200,201"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="Make sure that a Task is returned."/>
            <resource value="Task"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="Make sure that the Task has status=accepted."/>
            <expression value="Task.status = 'accepted'"/>
         </assert>
      </action>
   </test>
   <test id="Scenario1.3b-ServeNursingHandoff">
      <name value="Scenario1.3b - Serve NursingHandoff Composition"/>
      <description value="Scenario 1.3b - Test sending XIS to serve the nursing handoff Composition referenced in the eOverdracht Task."/>
      <action>
         <operation>
            <type>
               <system value="http://hl7.org/fhir/testscript-operation-codes"/>
               <code value="read"/>
            </type>
            <resource value="Composition"/>
            <description value="Test server to serve Composition resource."/>
            <accept value="xml"/>
            <destination value="1"/>
            <origin value="1"/>
            <params value="/${nursing-handoff-id}"/>
            <requestHeader>
               <field value="Authorization"/>
               <value value="${patient-token-id}"/>
            </requestHeader>
         </operation>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Confirm that the operation was succesful"/>
            <operator value="in"/>
            <responseCode value="200,201"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all coding elements contain both a .system and a .code."/>
            <direction value="response"/>
            <expression value="Composition.descendants().where($this.is(coding)).all(system.exists() and code.exists())"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the OID of the zib valueset is not used for the system of a coding element."/>
            <direction value="response"/>
            <expression value="Composition.descendants().where($this.is(coding)).system.startsWith('urn:oid:2.16.840.1.113883.2.4.3.11.60.40.2').not()"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all CodeableConcept elements contain either a coding.display or a text value if no Coding exists or has an extension (e.g. a nullFlavor or data-absent-reason extension). For more information see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3Use_of_coded_concepts."/>
            <direction value="response"/>
            <expression value="Composition.descendants().where($this.is(CodeableConcept)) .all(coding.display.exists() or text.exists() or extension.exists())"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all References have a display value, see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3#Use_of_the_reference_datatype."/>
            <direction value="response"/>
            <expression value="Composition.descendants().where($this.is(Reference)).all(display.exists())"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Composition conforms to the eOverdracht Nursing Handoff profile"/>
            <direction value="response"/>
            <validateProfileId value="eOverdracht-NursingHandoff"/>
         </assert>
      </action>
   </test>
   <test id="Scenario1.3b-RecieveTaskUpdate">
      <name value="Scenario1.3b - Handle update to eOverdracht Task"/>
      <description value="Test XIS server to handle an update to the eOverdracht Task with status 'completed'. This will be an update operation where the original Task is sent, with only the status element changed."/>
      <action>
         <operation>
            <type>
               <system value="http://hl7.org/fhir/testscript-operation-codes"/>
               <code value="update"/>
            </type>
            <resource value="Task"/>
            <description value="Test sending XIS to handle an update to the eOverdracht Task"/>
            <accept value="xml"/>
            <destination value="1"/>
            <origin value="1"/>
            <params value="/${task-id}"/>
            <requestHeader><!-- 0..* Each operation can have one or more header elements -->
               <field value="Authorization"/>
               <!-- 1..1 HTTP header field name: OAuth access token -->
               <value value="${patient-token-id}"/>
               <!-- 1..1 HTTP headerfield value: UUID4 -->
            </requestHeader>
            <sourceId value="completed-task-fixture"/>
         </operation>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Task conforms to the eOverdracht Task profile"/>
            <direction value="response"/>
            <validateProfileId value="eOverdracht-Task"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Task.status has been changed to 'completed'"/>
            <direction value="response"/>
            <expression value="Task.status = 'completed'"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Confirm that the update is succesful"/>
            <operator value="in"/>
            <responseCode value="200,201"/>
         </assert>
      </action>
   </test>
</TestScript>
