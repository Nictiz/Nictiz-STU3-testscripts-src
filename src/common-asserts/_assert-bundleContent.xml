<?xml version="1.0" encoding="UTF-8"?>
<!--
    Generic (internal) component to test the content of Bundles according to the Nictiz FHIR IG.
    @param direction - either "request" or "response".
-->
<nts:component xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript">
    <nts:include href="_assert-bundleContent-core.xml" />
    <action>
        <assert>
            <description value="Confirm that all CodeableConcept elements contain either a coding.display or a text value if no Coding exists or has an extension (e.g. a nullFlavor or data-absent-reason extension). For more information see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3Use_of_coded_concepts."/>
            <direction value="{$direction}"/>
            <expression value="Bundle.descendants().where($this.is(CodeableConcept))
                .all((coding.display.exists() or (coding.exists().not() and text.exists())) or extension.exists())"/>
        </assert>
    </action>
    <action>
        <assert>
            <description value="Confirm that all References have a display value, see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3#Use_of_the_reference_datatype."/>
            <direction value="{$direction}"/>
            <expression value="Bundle.descendants().where($this.is(Reference)).all(display.exists())"/>
        </assert>
    </action>
</nts:component>
