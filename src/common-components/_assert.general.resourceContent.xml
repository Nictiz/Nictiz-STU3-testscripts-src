<?xml version="1.0" encoding="UTF-8"?>
<!--
    Generic asserts for resource content against FHIR core and the Nictiz FHIR IG.
    @param resource - the resource type of which the contents are checked. 
    @param direction - either "request" or "response".
    @param allowCodeWithoutSystem - If set, the resource is allowed to have a .code without a .system. The content of this variable doesn't actually matter.
-->
<nts:component xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript">
    
    <action nts:ifnotset="allowCodeWithoutSystem">
        <assert>
            <description value="Confirm that all coding elements contain both a .system and a .code."/>
            <direction value="{$direction}"/>
            <expression value="{$resource}.descendants().where($this.is(coding)).all(system.exists() and code.exists())"/>
        </assert>
    </action>
    <action>
        <assert>
            <description value="Confirm that the OID of the zib valueset is not used for the system of a coding element."/>
            <direction value="{$direction}"/>
            <expression value="{$resource}.descendants().where($this.is(coding)).system.startsWith('urn:oid:2.16.840.1.113883.2.4.3.11.60.40.2').not()"/>
        </assert>
    </action>
    <action>
        <assert>
            <description value="Confirm that all CodeableConcept elements contain either a coding.display or a text value if no Coding exists or has an extension (e.g. a nullFlavor or data-absent-reason extension). For more information see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3Use_of_coded_concepts."/>
            <direction value="{$direction}"/>
            <expression value="{$resource}.descendants().where($this.is(CodeableConcept))
                .all(coding.display.exists() or text.exists() or extension.exists())"/>
        </assert>
    </action>
    <action>
        <assert>
            <description value="Confirm that all References have a display value, see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3#Use_of_the_reference_datatype."/>
            <direction value="{$direction}"/>
            <expression value="{$resource}.descendants().where($this.is(Reference)).all(display.exists())"/>
        </assert>
    </action>
</nts:component>
